Предисловие
к первому изданию
Реляционные базы данных, бесспорно, составляют основу современного пред-
приятия. В то время как современные языки программирования, включая Java,
обеспечивают интуитивное, объектно-ориентированное представление бизнес-
сущностей уровня приложения, данные, лежащие в основе этих сущностей, име-
ют выраженную реляционную природу. Кроме того, главное преимущество реля-
ционной модели перед более ранней навигационной моделью, а также поздними
моделями объектно-ориентированных баз данных – в том, что она изначально
внутренне независима от программных взаимодействий и представления данных
на уровне приложения. Было предпринято немало попыток для объединения ре-
ляционной и объектно-ориентированной технологий или замещения одной на
другую, но пропасть между ними остается сегодня одним из непреложных фак-
тов. Именно эту задачу – обеспечить связь между реляционными данными и Java-
объектами – решает Hibernate при помощи своего подхода к реализации объектно-
реляционного отображения (Object/Relational Mapping, ORM). Hibernate решает
данную задачу очень прагматичным, ясным и реалистичным способом.
Как показывают Кристиан Бауэр (Christian Bauer) и Гэвин Кинг (Gavin King)
в этой книге, эффективное использование технологии ORM в любом бизнес-окру-
жении, кроме простейшего, требует понимания особенностей работы механизма,
осуществляющего посредничество между реляционными данными и объектами.
То есть разработчик должен понимать требования к своему приложению и к дан-
ным, владеть языком SQL, знать структуры реляционных хранилищ, а также
иметь представление о возможных способах оптимизации, предоставляемых ре-
ляционными технологиями. Hibernate не только предоставляет полностью ра-
бочее решение, непосредственно удовлетворяющее этим требованиям, но и гиб-
кую и настраиваемую
архитектуру. Разработчики Hibernate изначально сделали
фреймворк модульным, расширяемым и легко настраиваемым под нужды поль-
зователя. В результате через несколько лет после выхода первой версии фрейм-
ворк Hibernate быстро стал – и заслуженно – одной из ведущих реализаций ORM-
технологий для разработчиков корпоративных приложений.
В этой книге представлен подробный обзор фреймворка Hibernate. Описыва-
ется, как использовать его возможности отображения типов и средства моделиро-
вания ассоциаций и наследования; как эффективно извлекать объекты, используя
﻿  17
язык запросов Hibernate; как настраивать Hibernate для работы в управляемом
и неуправляемом окружениях; как использовать его инструментарий. Кроме того,
на протяжении всей книги авторы приоткрывают проблемы ORM и проектные
решения, легшие в основу Hibernate. Это дает читателю глубокое понимание эф-
фективного использования ORM как корпоративной технологии. Данная кни-
га является подробным руководством по Hibernate и объектно-реляционному
отображению
в корпоративных вычислениях.
Линда Демишель (Linda DeMichiel)
Ведущий архитектор, Enterprise Javabeans
Sun Microsystems
Ноябрь 2012
Введение
Это наша третья книга о Hibernate, проекте с открытым исходным кодом, которому
почти 15 лет. Согласно недавнему опросу, Hibernate оказался в числе пяти самых
популярных инструментов, которыми Java-разработчики пользуются каждый день.
Это говорит о том, что базы данных SQL являются предпочтительной технологией
для надежного хранения и управления данными, особенно в области разработки
корпоративных приложений на Java. Также это является доказательством качества
доступных спецификаций и инструментов, упрощающих запуск проектов, оценку
и снижение рисков при создании крупных и сложных приложений.
Сейчас доступны пятая версия Hibernate и вторая версия спецификации Java
Persistence API (JPA), которую реализует Hibernate. Ядро Hibernate или то, что
сейчас называется объектно-реляционным отображением (Object/Relational Mapping,
ORM), уже долгое время является развитой технологией, и на протяжении
многих лет было сделано множество мелких улучшений. Другие связанные проек-
ты, такие как Hibernate Search, Hibernate Bean Validation и недавнее объектно-се-
точное отображение (Object/Grid Mapping, OGM), привносят новые инновацион-
ные решения, которые превращают Hibernate в полноценный набор инструментов
для решения широкого спектра задач управления данными.
Когда мы работали над предыдущим изданием этой книги, с Hibernate проис-
ходили важные изменения: в силу своего органичного развития, влияния со сто-
роны сообщества разработчиков свободного ПО и повседневных требований Java-
разработчиков Hibernate пришлось стать более формальным и реализовать первую
версию спецификации JPA (Java Persistence API). Поэтому предыдущее издание
получилось громоздким, так как многие примеры мы были вынуждены демонстри-
ровать с использованием старого и нового, стандартизированного, подходов.
В настоящий момент этот расхождение практически исчезло, и мы можем в пер-
вую очередь опираться на стандартизированный прикладной программный ин-
терфейс (API) и архитектуру Java Persistence. Также в этом издании мы обсудим
множество выдающихся особенностей Hibernate. Хотя объем книги уменьшился,
по сравнению с предыдущим изданием, мы использовали это место для много-
численных новых примеров. Мы также рассмотрим, как JPA вписывается в общую
картину Java EE и как ваше приложение может интегрировать Bean Validation,
EJB, CDI и JSF.
Пусть это новое издание станет путеводителем для вашего первого проекта Hibernate.
Мы надеемся, что оно заменит предыдущее издание в качестве настольно-
го справочного материала по Hibernate.
Благодарности
Мы не смогли бы написать эту книгу без помощи многих людей. Палак Матур
(Palak Mathur) и Кристиан Альфано (Christian Alfano) проделали отличную рабо-
ту, будучи техническими рецензентами нашей книги; спасибо вам за долгие часы,
потраченные на редактирование наших «поломанных» примеров кода.
Мы также хотели бы поблагодарить наших рецензентов за потраченное вре-
мя и неоценимую обратную связь в процессе разработки: Криса Бакара (Chris
Bakar), Гаурава Бхардвая (Gaurav Bhardwaj), Якоба Босму (Jacob Bosma), Хосе
Диаза (José Diaz), Марко Гамбини (Marco Gambini), Серхио Фернандеса Гон-
салеса (Sergio Fernandez Gonzalez), Джерри Гуднафа (Jerry Goodnough), Джона
Гриффина (John Griffin), Стефана Хеффнера (Stephan Heffner), Чеда Джонсто-
на (Chad Johnston), Кристофа Мартини (Christophe Martini), Робби О’Коннора
(Robby O’Connor), Антони Патрисио (Anthony Patricio) и Дениса Ванга (Denis
Wang).
Издатель из Manning Марьян Бэйс (Marjan Bace) снова собрала отличную ко-
манду в Manning: Кристина Тэйлор (Christina Taylor) редактировала нашу сырую
рукопись, превратив ее в настоящую книгу. Тиффани Тэйлор (Tiffany Taylor) на-
шла все опечатки, сделав книгу читаемой. Дотти Мариско (Dottie Marisco), от-
ветственная за верстку, придала книге ее прекрасный вид. Мэри Пиргис (Mary
Piergies) координировала и организовывала весь процесс. Мы благодарим всех вас
за то, что работали с нами.
Наконец, отдельное спасибо Линде Демишель (Linda DeMichiel) за предисло-
вие к первому изданию.
Гэри Грегори (Gary Gregory)
Я хотел бы поблагодарить моих родителей за то, что помогли мне начать это
путешествие, дали мне прекрасное образование и свободу выбирать свой путь.
Я бесконечно благодарен своей жене Лори и моему сыну Александру за то, что
они предоставили мне время на завершение еще одного проекта – моей третьей
книги.
В процессе работы я учился и сотрудничал с действительно выдающимися
личностями, такими как Джордж Босворт (George Bosworth), Ли Брайзахер (Lee
Breisacher), Кристофер Хэнсон (Christopher Hanson), Дебора Льюис (Deborah
Lewis) и многими другими. Мой тесть, Бадди Мартин (Buddy Martin), заслужива-
ет особого упоминания за то, что делился своей мудростью и проницательностью
во время долгих бесед и рассказов историй, накопленных за те десятилетия, что
он писал о спорте (вперед, «Аллигаторы»!). Я всегда нахожу вдохновение в му-
20  Благодарности
зыке, особенно в музыке следующих исполнителей: Wilco (Impossible Germany),
Tom Waits (Blue Valentine), Donald Fagen (The Night-fly, A just machine to make big
decisions/Programmed by fellows with compassion and vision), David Lindley и Баха.
Наконец, я благодарю своего соавтора Кристиана Бауэра (Christian Bauer) за то,
что делился со мной знаниями, и всех сотрудников издательства Manning за под-
держку, профессионализм и доброжелательные отзывы.
Отдельное спасибо Тиффани Тэйлор (Tiffany Taylor) из Manning за то, что при-
дала книге отличный вид. Дон Вэннер (Don Wanner), спасибо, точка.
Об этой книге
Эта книга является и руководством, и справочником по Hibernate и Java Persistence.
Если вы новичок в Hibernate, рекомендуем читать, начиная с главы 1,
и опробовать все примеры с «Hello World» в главе 2. Если вы использовали ста-
рую версию Hibernate, прочитайте бегло две первые главы, чтобы получить общее
представление, и переходите к середине главы 3. Там, где необходимо, мы сооб-
щим, если конкретный раздел или тема являются дополнительными или справоч-
ными, которые можно пропустить при первом чтении.
Структура книги
Эта книга состоит из пяти больших частей.
В части I «Начинаем работать с ORM» мы обсудим основы объектно-реляцион-
ного отображения. Пройдемся по практическому руководству, чтобы помочь вам
создать первый проект с Hibernate. Рассмотрим проектирование Java-приложений
с точки зрения создания моделей предметной области и познакомимся с варианта-
ми определения метаданных для объектно-реляционного отображения.
В части II «Стратегии отображения» рассказывается о классах Java и их свой-
ствах, а также об их отображении в таблицы и столбцы SQL. Мы рассмотрим все
основные и продвинутые способы отображения в Hibernate и Java Persistence. По-
кажем, как работать с наследованием, коллекциями и сложными ассоциациями
классов. В заключение обсудим интеграцию с существующими схемами баз дан-
ных, а также особенно запутанные стратегии отображения.
Часть III «Транзакционная обработка данных» посвящена загрузке и сохране-
нию данных с помощью Hibernate и Java Persistence. Мы представим программные
интерфейсы, способы создания транзакционных приложений и то, как эффектив-
нее загружать данные из базы данных в Hibernate.
В части IV «Создание запросов» мы познакомимся с механикой извлечения
данных и детально рассмотрим язык запросов и прикладной программный интер-
фейс (API). Не все главы данного раздела написаны как руководство; мы рассчи-
тываем, что вы будете часто заглядывать в эту часть книги во время разработки
приложений для поиска решений проблем с конкретными запросами.
В части V «Разработка приложений» мы обсудим проектирование и разработку
многоуровневых приложений баз данных на Java. Обсудим наиболее распростра-
ненные шаблоны проектирования, используемые вместе с Hibernate, такие как
«Объект доступа к данным» (Data Access Object, DAO). Вы увидите, как можно
легко протестировать приложение, использующее Hibernate, и познакомитесь
с другими распространенными приемами, используемыми при работе с инстру-
ментами объектно-реляционного отображения в веб-приложениях или клиент-
серверных приложениях в целом.
22  Об этой книге
Кому адресована эта книга?
Читатели данной книги должны быть знакомы с основами объектно-ориентиро-
ванного программирования и иметь практические навыки его применения. Чтобы
понять примеры приложений, вы должны быть знакомы с языком программиро-
вания Java и унифицированным языком моделирования (Unified Modeling Language,
UML).
В первую очередь книга адресована Java-программистам, работающим с базами
данных SQL. Мы покажем, как повысить продуктивность при работе с ORM. Если
вы – разработчик баз данных, эта книга может отчасти послужить вам введением
в объектно-ориентированную разработку программного обеспечения.
Если вы администратор баз данных (DBA), вас наверняка заинтересует влияние
ORM на производительность, а также способы настройки СУБД SQL и уровня
хранения данных для достижения желаемой производительности. Доступ к дан-
ным является узким местом любого Java-приложения, поэтому проблемам произ-
водительности в данной книге уделяется повышенное внимание. Многие DBA, по
понятным причинам, испытывают тревогу, не веря в высокую производительность
автоматически сгенерированного кода SQL; мы постараемся развеять эти страхи,
а также указать случаи, когда в приложениях не следует использовать автомати-
ческого доступа к данным. Вы почувствуете себя свободнее, когда поймете, что мы
не считаем ORM лучшим решением для каждой проблемы.
Соглашения об оформлении программного кода
Эта книга изобилует примерами, включающими всевозможные артефакты
Hibernate-приложений: Java-код, файлы конфигурации Hibernate и XML-файлы
с метаданными отображений. Исходный код в листингах или тексте выделен моноши-
ринным шрифтом, как этот, чтобы отделить его от остального текста. Кроме того,
имена
Java-методов, параметры компонентов, свойства объектов, а также XML-элементы
и их атрибуты в тексте представлены с использованием моноширинного шрифта.
Листинги на Java, XML и HTML могут быть объемными. Во многих случаях ис-
ходный код (доступный онлайн) был переформатирован; мы добавили разделите-
ли строк и переделали отступы, чтобы уместить их по ширине книжных страниц.
В редких случаях, когда этого оказалось недостаточно, в листинги были добавле-
ны символы продолжения строки (➥). Также из многих листингов, описываемых
в тексте, мы убрали комментарии. Некоторые листинги сопровождают аннотации,
выделяющие важные понятия. В других случаях используются пронумерованные
маркеры, отсылающие к пояснениям в тексте, следующим за листингами.
Загрузка исходного кода
Hibernate – это проект с открытым исходным кодом, распространяемым на усло-
виях лицензии Lesser GNU Public Lisence. Инструкции по загрузке модулей Hibernate
в виде исходных или двоичных кодов доступны на сайте проекта: http://
авторах  23
hibernate.org/. Исходный код всех примеров в данной книге доступен на http://
jpwh.org. Код примеров можно также загрузить с сайта издательства https://www.
manning.com/books/java-persistence-with-hibernate-second-edition.
Автор онлайн
Приобретая книгу «Java Persistence API и Hibernate», вы получаете бесплатный
доступ на частный веб-форум издательства Manning Publications, где вы сможете
оставлять отзывы о книге, задавать технические вопросы и получать помощь от
авторов и других пользователей. Чтобы получить доступ к форуму и зарегистри-
роваться на нем, откройте в браузере страницу https://www.manning.com/books/
java-persistence-with-hibernate-second-edition. На этой странице «Author Online»
(Автор в сети) описывается, как попасть на форум после регистрации, какие виды
помощи доступны и правила поведения на форуме.
Издательство Manning обязуется предоставить своим читателям место встре-
чи, где может состояться содержательный диалог между отдельными читателями
и между читателями и автором. Но со стороны автора отсутствуют какие-либо
обязательства уделять форуму какое-то определенное внимание – его присут-
ствие на форуме остается добровольным (и неоплачиваемым). Мы предлагаем за-
давать автору стимулирующие вопросы, чтобы его интерес не угасал!
Форум и архивы предыдущих дискуссий будут оставаться доступными, пока
книга продолжает издаваться.
Об авторах
Кристиан Бауэр (Christian Bauer) – член коллектива разработчиков Hibernate; он
работает инструктором и консультантом.
Гэвин Кинг (Gavin King) – основатель проекта Hibernate и член первоначально-
го состава экспертной группы по Java Persistence (JSR 220). Он также участвовал
в работе по стандартизации CDI (JSR 299). В настоящее время Гэвин разрабаты-
вает новый язык программирования Ceylon.
Гэри Грегори (Gary Gregory) является главным инженером в Rocket Software,
где работает над серверами приложений и интеграцией с устаревшими системами.
Еще он соавтор книг издательства Manning: «JUnit in Action» и «Spring Batch in
Action», а также член комитетов по руководству проектом (Project Management
Commitee) в различных проектах в Apache Software Foundation: Commons, Http-
Components, Logging Services и Xalan.
Об изображении
на обложке
Иллюстрация на обложке книги «Java Persistence API и Hibernate, второе изда-
ние» взята из сборника костюмов Османской империи, изданного 1 января 1802 г.
Вильямом Миллером (William Miller) в Old Bond Street, Лондон. Титульный лист
сборника утерян, поэтому мы не смогли точно определить дату его выхода. В со-
держании книги изображения описаны на английском и французском языках,
и под каждой иллюстрацией приводятся имена двух художников, которые труди-
лись над ней. Не сомневаемся, что все они, несомненно, были бы удивлены, узнав,
что их творчество украсит обложку книги по программированию... 200 лет спустя.
Рисунки из сборника костюмов Османской империи, так же как и другие ил-
люстрации, появляющиеся на наших обложках, возрождают богатство и разнообразие
традиций в одежде двухсотлетней давности. Они напоминают о чувствах
уединенности и удаленности этого периода – и любого другого исторического пе-
риода, кроме нашего гиперкинетического настоящего. Манеры одеваться сильно
изменились с тех пор, а своеобразие каждого региона, такое яркое в то время, дав-
но поблекло. Сейчас бывает трудно различить обитателей разных континентов.
Возможно, если смотреть на это оптимистично, мы обменяли культурное и визуальное
разнообразие на более разнообразную частную жизнь или более разнообразную
интеллектуальную и техническую жизнь.
Мы в Manning высоко ценим изобретательность, инициативу и, конечно, ра-
дость от компьютерного бизнеса с книжными обложками, основанными на раз-
нообразии жизни в разных регионах два века назад, которое оживает благодаря
картинкам из этой коллекции.
ID << PK >>
STREET
ZIPCODE
CITY
<< Table >>
ADDRESS
ID << PK >> << FK >>
USERNAME
FIRSTNAME
LASTNAME
<< Table >>
USERS
ID << PK >>
CC_OWNER
CARDNUMBER
EXPMONTH
EXPYEAR
<< Table CREDITCARD
owner : String
BillingDetails
id : Long
cardNumber : String
expMonth : String
expYear : String
CreditCard
id : Long
account : String
bankname : String
swift : String
BankAccount
Часть I
НАЧИНАЕМ
РАБОТАТЬ С ORM
В части I мы объясним, почему долговременное хранение объектов является та-
кой сложной темой, и расскажем о некоторых практических решениях. В главе
1 описывается несоответствие объектной и реляционной парадигм и приводится
несколько стратегий для преодоления этого несоответствия – в первую очередь
объектно-реляционное отображение (ORM). В главе 2 мы по шагам разберем
с вами учебный пример с Hibernate и Java Persistence – программу «Hello World».
После такой начальной подготовки в главе 3 вы узнаете, как проектировать и раз-
рабатывать сложные предметные модели на Java и какие виды метаданных ото-
бражения доступны.
После прочтения этой части книги вы поймете, для чего требуется ORM и как
Hibernate и Java Persistence работают на практике. Вы создадите свой первый
небольшой проект и подготовитесь к решению более сложных задач. Вы также
узнаете,
как представлять реальные бизнес-сущности в виде предметных моделей
на Java, и выберете наиболее предпочтительный формат для работы с метаданны-
ми ORM.